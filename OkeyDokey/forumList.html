<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>forumList</title>
        <!--폰트 적용-->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Varela+Round">
    <!-- 가장기본이 되는 css 코드-->
    <link rel="stylesheet" href="../bootstrap-4.6.2-dist/css/bootstrap.css">
    <link rel="stylesheet" href="forumList.css">
</head>
<body>
  <?php
  // PHP 코드를 여기에 작성합니다.
  //이렇게 하면 브라우저에 에러 메시지가 표시됩니다. 
  error_reporting(E_ALL);
  ini_set('display_errors', 1);
  //

  //1. mysql과 연결하기
  $host = '52.79.41.79';
  $user = 'datagrip';
  $pw = 'abc123';
  $db_name = 'mydb';

  $connect = mysqli_connect($host, $user, $pw, $db_name);

  if ($connect->connect_error) {
      die("Connection failed: " . $connect->connect_error);
  }

  //2. SELECT 쿼리 전송 
  /* join사용해서 forums 테이블과 answers 테이블의 데이터를 한번에 가져온다 */

  $sql = "SELECT forums.forumTitle, forums.userId, forums.forumDate, answers.userId, answers.answerDate, users.userImg, users.userName, users2.userName AS forumUserName,
 /* 서브쿼리 COUNT 함수를 사용해서 forumId에 대한 answers 테이블의 행의 갯수 가져오기 */
  (
    SELECT COUNT(*)
    FROM answers
    WHERE answers.forumId = forums.forumId
  ) AS answerCount

  /* 한쪽 테이블(answers)가 없는 경우에도 렌더링 될 수 있도록 LEFT JOIN 사용하기 */
        FROM forums 
        LEFT JOIN answers ON forums.forumId = answers.forumId
        LEFT JOIN users ON answers.userId = users.userId 
        JOIN users AS users2 ON forums.userId = users2.userId /* users테이블 겹치니까 별칭사용함 */
        ORDER BY forums.forumDate DESC"; /* 내림차순으로 글목록 번호 가져옴 */

  $result=$connect->query($sql);

  ?>
    <!--따온 코드 넣기-->
    <!-- Header-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
         <!-- Logo -->
    <a class="navbar-brand" href="#">
        <img src="../img/okeydokey1.png" class="h-8" alt="..">
      </a>
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Collection of nav links, forms, and other content for toggling -->
        <div id="navbarCollapse" class="collapse navbar-collapse justify-content-start">
            <class class="navbar-nav">
                <a href="#" class="nav-item nav-link">Home</a>
                <a href="#" class="nav-item nav-link">About</a>			
                <a href="#" class="nav-item nav-link active">Pricing</a>
                <a href="#" class="nav-item nav-link">Blog</a>
                <a href="#" class="nav-item nav-link">Contact</a>
                <form class="navbar-form form-inline">
                    <div class="input-group search-box">								
                        <input type="text" id="search" class="form-control" placeholder="Search here...">
                        <div class="input-group-append">
                            <span class="input-group-text">
                                <i class="material-icons">&#xE8B6;</i>
                            </span>
                        </div>
                    </div>
                </form>
                </class>
            </div>
            <div class="navbar-nav ml-auto action-buttons">
                <div class="nav-item dropdown">
                    <a href="#" data-toggle="dropdown" class="nav-link dropdown-toggle mr-4">Login</a>
                </div>
                <div class="nav-item dropdown">
                    <a href="#" data-toggle="dropdown" class="btn btn-primary dropdown-toggle sign-up-btn">Sign up</a>
                </div>
            </div>
        </div>
    </nav>
    <!-- Main-->
    <div class="container-fluid mt-100">
      <div class="d-flex flex-wrap justify-content-between">
      <div> <button type="button" class="btn btn-shadow btn-wide btn-primary" id="newThreadBtn"> <span class="btn-icon-wrapper pr-2 opacity-7"> <i class="fa fa-plus fa-w-20"></i> </span> New thread </button> </div>
      <div class="col-12 col-md-3 p-0 mb-3"> <input type="text" class="form-control" placeholder="Search..."> </div>
      </div>
      <div class="card mb-3">
      <div class="card-header pl-0 pr-0">
      <div class="row no-gutters w-100 align-items-center">
      <div class="col ml-3">Topics</div>
      <div class="col-4 text-muted">
      <div class="row no-gutters align-items-center">
      <div class="col-4">Answers</div>
      <div class="col-8">Last update</div>
      </div>
      </div>
      </div>
      </div>

      <!--db에서 데이터 가져옴-->
      <?php
      //3. 가져온 데이터로 목차 생성

      //while 반복문은 mysql 결과 집합에서 각 행을 하나씩 가져와서 html 목차를 동적으로 생성합니다.
      //이때, 'fetch_assoc()' 함수를 통해  MySQL 결과 집합의 한 행을 연관배열(associative array)로 가져옵니다
      
      while($rows = mysqli_fetch_assoc($result)){
        ?>
        <div class="card-body py-3">
        <div class="row no-gutters align-items-center">
        <div class="col"> <a href="javascript:void(0)" class="text-big" data-abc="true"><?php echo $rows['forumTitle']?></a>
          <!--forums 테이블의 userId 행의 userName이 들어가야 함-->
        <div class="text-muted small mt-1">Started <?php echo $rows['forumDate']?> &nbsp;·&nbsp; <a href="javascript:void(0)" class="text-muted" data-abc="true"><?php echo $rows['forumUserName']?></a></div>
        </div>
        <div class="d-none d-md-block col-4">
        <div class="row no-gutters align-items-center">
          <!-- answerCount 부분은 각 forumId에 대한 answers 테이블 행의 갯수를 의미한다-->
        <div class="col-4"><?php echo $rows['answerCount']?></div>
        <div class="media col-8 align-items-center"> <img src="<?php echo $rows['userImg']?>" alt="" class="d-block ui-w-30 rounded-circle">
        <div class="media-body flex-truncate ml-2">
        <div class="line-height-1 text-truncate"><?php echo $rows['answerDate']?></div>
        <div class="text-muted small text-truncate">by <?php echo $rows['userName']?></div>
        </div>
        </div>
        </div>
        </div>
        </div>
        </div>
        <hr class="m-0">
        <?php
      }
        // MySQL 연결 닫기
        $connect->close();
      ?>

      </div>
      <nav>
      <ul class="pagination mb-5">
      <li class="page-item disabled"><a class="page-link" href="javascript:void(0)" data-abc="true">«</a></li>
      <li class="page-item active"><a class="page-link" href="javascript:void(0)" data-abc="true">1</a></li>
      <li class="page-item"><a class="page-link" href="javascript:void(0)" data-abc="true">2</a></li>
      <li class="page-item"><a class="page-link" href="javascript:void(0)" data-abc="true">3</a></li>
      <li class="page-item"><a class="page-link" href="javascript:void(0)" data-abc="true">»</a></li>
      </ul>
      </nav>
      </div> 
    <!-- Footer-->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

    <footer class="footer_area section_padding_130_0">
          <div class="container">
            <div class="row">
              <!-- Single Widget-->
              <div class="col-12 col-sm-6 col-lg-4">
                <div class="single-footer-widget section_padding_0_130">
                  <!-- Footer Logo-->
                  <div class="footer-logo mb-3"></div>
                  <p>Appland is completely creative, lightweight, clean app landing page.</p>
                  <!-- Copywrite Text-->
                  <div class="copywrite-text mb-5">
                    <p class="mb-0">Made with <i class="lni-heart mr-1"></i>by<a class="ml-1" href="https://wrapbootstrap.com/user/DesigningWorld">Designing World</a></p>
                  </div>
                  <!-- Footer Social Area-->
                  <div class="footer_social_area"><a href="#" data-toggle="tooltip" data-placement="top" title="" data-original-title="Facebook"><i class="fa fa-facebook"></i></a><a href="#" data-toggle="tooltip" data-placement="top" title="" data-original-title="Pinterest"><i class="fa fa-pinterest"></i></a><a href="#" data-toggle="tooltip" data-placement="top" title="" data-original-title="Skype"><i class="fa fa-skype"></i></a><a href="#" data-toggle="tooltip" data-placement="top" title="" data-original-title="Twitter"><i class="fa fa-twitter"></i></a></div>
                </div>
              </div>
              <!-- Single Widget-->
              <div class="col-12 col-sm-6 col-lg">
                <div class="single-footer-widget section_padding_0_130">
                  <!-- Widget Title-->
                  <h5 class="widget-title">About</h5>
                  <!-- Footer Menu-->
                  <div class="footer_menu">
                    <ul>
                      <li><a href="#">About Us</a></li>
                      <li><a href="#">Corporate Sale</a></li>
                      <li><a href="#">Terms &amp; Policy</a></li>
                      <li><a href="#">Community</a></li>
                    </ul>
                  </div>
                </div>
              </div>
              <!-- Single Widget-->
              <div class="col-12 col-sm-6 col-lg">
                <div class="single-footer-widget section_padding_0_130">
                  <!-- Widget Title-->
                  <h5 class="widget-title">Support</h5>
                  <!-- Footer Menu-->
                  <div class="footer_menu">
                    <ul>
                      <li><a href="#">Help</a></li>
                      <li><a href="#">Support</a></li>
                      <li><a href="#">Privacy Policy</a></li>
                      <li><a href="#">Term &amp; Conditions</a></li>
                      <li><a href="#">Help &amp; Support</a></li>
                    </ul>
                  </div>
                </div>
              </div>
              <!-- Single Widget-->
              <div class="col-12 col-sm-6 col-lg">
                <div class="single-footer-widget section_padding_0_130">
                  <!-- Widget Title-->
                  <h5 class="widget-title">Contact</h5>
                  <!-- Footer Menu-->
                  <div class="footer_menu">
                    <ul>
                      <li><a href="#">Call Centre</a></li>
                      <li><a href="#">Email Us</a></li>
                      <li><a href="#">Term &amp; Conditions</a></li>
                      <li><a href="#">Help Center</a></li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </footer>
    <!-- jQuery와 bootstrap 적용-->
    <!--jQuery는 bootstrap의 js가 사용하므로 bootstrap js 파일 로드 전 로드한다.-->
    <script src="../jQuery/jquery-3.7.1.js"></script>
    <!-- <body> 태그가 끝나기 전 js 파일 로드 시 웹 페이지 로딩 속도 향상된다.-->
    <script src="../bootstrap-4.6.2-dist/js/bootstrap.js"></script>
<script>
  document.getElementById('newThreadBtn').addEventListener('click', function() {
      // 클릭 이벤트 발생 시 forumWriting.html로 페이지 이동
      window.location.href = 'forumWriting.html';
  });
</script>
</body>
</html>